name: Deploy Backend

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - '.github/workflows/BE.yml'

jobs:
  deploy-backend:
    runs-on: ubuntu-latest  # ✅ REQUIRED FIX

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Zip backend files
        run: |
          cd server
          zip -r backend.zip . -x "node_modules/*"

      - name: Upload backend to Windows Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_IP }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          source: "server/backend.zip"
          target: "C:/inetpub/wwwroot/dev.imraninnovations"

      - name: Deploy backend
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.EC2_IP }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          script: |
            $deployPath = "C:\inetpub\wwwroot\dev.imraninnovations\server"
            $zipPath = "C:\inetpub\wwwroot\dev.imraninnovations\backend.zip"
            Expand-Archive -Path $zipPath -DestinationPath $deployPath -Force
            Remove-Item $zipPath -Force
            cd $deployPath
            npm install --production
            Write-Host "✅ Backend deployed successfully"
